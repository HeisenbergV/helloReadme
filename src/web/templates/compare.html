{% extends "base.html" %}

{% block title %}é¡¹ç›®å¯¹æ¯”åˆ†æ - å¼€æºé¡¹ç›®æ¨è{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-balance-scale me-2"></i>
                        é¡¹ç›®å¯¹æ¯”åˆ†æ - æ™ºèƒ½å¯¹æ¯”æ¨è
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- å·¦ä¾§ï¼šé¡¹ç›®é€‰æ‹©åŒºåŸŸ -->
                        <div class="col-md-4">
                            <div class="mb-4">
                                <h5>ğŸ“‹ é€‰æ‹©å¯¹æ¯”é¡¹ç›®</h5>
                                <p class="text-muted">
                                    é€‰æ‹©2-5ä¸ªé¡¹ç›®è¿›è¡Œæ™ºèƒ½å¯¹æ¯”åˆ†æ
                                </p>
                                
                                <!-- é¡¹ç›®æœç´¢ -->
                                <div class="mb-3">
                                    <label for="projectSearch" class="form-label">æœç´¢é¡¹ç›®ï¼š</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="projectSearch" placeholder="è¾“å…¥é¡¹ç›®åç§°æˆ–æè¿°å…³é”®è¯...">
                                        <button class="btn btn-outline-secondary" type="button" onclick="searchProjects()">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- é¡¹ç›®åˆ—è¡¨ -->
                                <div class="mb-3">
                                    <label class="form-label">æœç´¢ç»“æœï¼š</label>
                                    <div id="searchResults" class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                                        <div class="text-muted text-center py-3">
                                            <i class="fas fa-search me-2"></i>
                                            æœç´¢é¡¹ç›®ä»¥å¼€å§‹å¯¹æ¯”
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- å·²é€‰é¡¹ç›® -->
                                <div class="mb-3">
                                    <label class="form-label">å·²é€‰é¡¹ç›® (<span id="selectedCount">0</span>/5)ï¼š</label>
                                    <div id="selectedProjects" class="border rounded p-2" style="min-height: 100px;">
                                        <div class="text-muted text-center py-3">
                                            <i class="fas fa-plus me-2"></i>
                                            ä»æœç´¢ç»“æœä¸­é€‰æ‹©é¡¹ç›®
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- å¯¹æ¯”ç±»å‹é€‰æ‹© -->
                                <div class="mb-3">
                                    <label for="comparisonType" class="form-label">å¯¹æ¯”ç±»å‹ï¼š</label>
                                    <select class="form-select" id="comparisonType">
                                        <option value="detailed">å…¨é¢å¯¹æ¯”åˆ†æ</option>
                                        <option value="technical">æŠ€æœ¯å±‚é¢å¯¹æ¯”</option>
                                        <option value="community">ç¤¾åŒºæ´»è·ƒåº¦å¯¹æ¯”</option>
                                    </select>
                                    <small class="text-muted">
                                        ğŸ’¡ å…¨é¢å¯¹æ¯”åŒ…å«æŠ€æœ¯ã€åŠŸèƒ½ã€ç¤¾åŒºç­‰å…¨æ–¹ä½åˆ†æ
                                    </small>
                                </div>
                                
                                <button 
                                    class="btn btn-info btn-lg w-100" 
                                    id="compareBtn"
                                    onclick="startComparison()"
                                    disabled
                                >
                                    <i class="fas fa-balance-scale me-2"></i>
                                    å¼€å§‹å¯¹æ¯”åˆ†æ
                                </button>
                                
                                <div class="mt-3">
                                    <small class="text-muted">
                                        ğŸ’¡ æç¤ºï¼šé€‰æ‹©æ›´å¤šé¡¹ç›®å¯ä»¥è·å¾—æ›´å…¨é¢çš„å¯¹æ¯”åˆ†æ
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å³ä¾§ï¼šå¯¹æ¯”ç»“æœåŒºåŸŸ -->
                        <div class="col-md-8">
                            <div class="mb-4">
                                <h5>ğŸ“Š å¯¹æ¯”åˆ†æç»“æœ</h5>
                                
                                <!-- åŠ è½½çŠ¶æ€ -->
                                <div id="loadingState" class="d-none">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-info" role="status">
                                            <span class="visually-hidden">åˆ†æä¸­...</span>
                                        </div>
                                        <p class="mt-3 text-muted">AIæ­£åœ¨åˆ†æé¡¹ç›®ï¼Œè¯·ç¨å€™...</p>
                                    </div>
                                </div>
                                
                                <!-- é”™è¯¯çŠ¶æ€ -->
                                <div id="errorState" class="d-none">
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>åˆ†æå¤±è´¥ï¼š</strong>
                                        <span id="errorMessage"></span>
                                    </div>
                                </div>
                                
                                <!-- å¯¹æ¯”ç»“æœ -->
                                <div id="comparisonResult" class="d-none">
                                    <div class="card border-info">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-chart-bar me-2"></i>
                                                AIå¯¹æ¯”åˆ†æç»“æœ
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="comparisonContent" class="mb-3"></div>
                                            <div class="text-muted small">
                                                <span id="comparisonModel"></span>
                                                <span id="comparisonUsage" class="ms-3"></span>
                                                <span id="comparisonProjects" class="ms-3"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- å¿«é€Ÿå¯¹æ¯”ç¤ºä¾‹ -->
                                <div id="quickExamples" class="mt-4">
                                    <h6>ğŸš€ å¿«é€Ÿå¯¹æ¯”ç¤ºä¾‹</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6 class="card-title">AIæ¡†æ¶å¯¹æ¯”</h6>
                                                    <p class="card-text text-muted">å¯¹æ¯”TensorFlowã€PyTorchç­‰ä¸»æµAIæ¡†æ¶</p>
                                                    <button class="btn btn-sm btn-outline-info" onclick="fillQuickExample('AIæ¡†æ¶')">
                                                        ä½¿ç”¨æ­¤ç¤ºä¾‹
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6 class="card-title">Webæ¡†æ¶å¯¹æ¯”</h6>
                                                    <p class="card-text text-muted">å¯¹æ¯”Djangoã€Flaskã€FastAPIç­‰Webæ¡†æ¶</p>
                                                    <button class="btn btn-sm btn-outline-info" onclick="fillQuickExample('Webæ¡†æ¶')">
                                                        ä½¿ç”¨æ­¤ç¤ºä¾‹
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedProjects = [];

// æœç´¢é¡¹ç›®
async function searchProjects() {
    const searchTerm = document.getElementById('projectSearch').value.trim();
    if (!searchTerm) {
        showSearchError('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
        return;
    }
    
    try {
        const response = await fetch('/api/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: searchTerm,
                limit: 20
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displaySearchResults(data.results);
        } else {
            showSearchError(data.error || 'æœç´¢å¤±è´¥');
        }
        
    } catch (error) {
        console.error('æœç´¢è¯·æ±‚å¤±è´¥:', error);
        showSearchError('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }
}

// æ˜¾ç¤ºæœç´¢ç»“æœ
function displaySearchResults(projects) {
    const container = document.getElementById('searchResults');
    
    if (!projects || projects.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-3">æœªæ‰¾åˆ°ç›¸å…³é¡¹ç›®</div>';
        return;
    }
    
    let html = '';
    projects.forEach(project => {
        const isSelected = selectedProjects.some(p => p.id === project.id);
        html += `
            <div class="border-bottom py-2 ${isSelected ? 'bg-light' : ''}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${project.name}</h6>
                        <p class="mb-1 small text-muted">${project.description || 'æ— æè¿°'}</p>
                        <div class="small">
                            <span class="badge bg-primary me-1">${project.language || 'æœªçŸ¥'}</span>
                            <span class="badge bg-success me-1">â­ ${project.stars || 0}</span>
                            <span class="badge bg-info">ğŸ”€ ${project.forks || 0}</span>
                        </div>
                    </div>
                    <button 
                        class="btn btn-sm ${isSelected ? 'btn-secondary' : 'btn-outline-primary'}"
                        onclick="toggleProjectSelection(${project.id}, '${project.name}', '${project.description || ''}', '${project.language || ''}', ${project.stars || 0}, ${project.forks || 0})"
                        ${isSelected ? 'disabled' : ''}
                    >
                        ${isSelected ? 'å·²é€‰æ‹©' : 'é€‰æ‹©'}
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// åˆ‡æ¢é¡¹ç›®é€‰æ‹©
function toggleProjectSelection(projectId, name, description, language, stars, forks) {
    const project = {
        id: projectId,
        name: name,
        description: description,
        language: language,
        stars: stars,
        forks: forks
    };
    
    const index = selectedProjects.findIndex(p => p.id === projectId);
    if (index === -1) {
        if (selectedProjects.length >= 5) {
            alert('æœ€å¤šåªèƒ½é€‰æ‹©5ä¸ªé¡¹ç›®è¿›è¡Œå¯¹æ¯”');
            return;
        }
        selectedProjects.push(project);
    } else {
        selectedProjects.splice(index, 1);
    }
    
    updateSelectedProjectsDisplay();
    updateCompareButton();
}

// æ›´æ–°å·²é€‰é¡¹ç›®æ˜¾ç¤º
function updateSelectedProjectsDisplay() {
    const container = document.getElementById('selectedProjects');
    const countSpan = document.getElementById('selectedCount');
    
    countSpan.textContent = selectedProjects.length;
    
    if (selectedProjects.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-plus me-2"></i>ä»æœç´¢ç»“æœä¸­é€‰æ‹©é¡¹ç›®</div>';
        return;
    }
    
    let html = '';
    selectedProjects.forEach((project, index) => {
        html += `
            <div class="border-bottom py-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${index + 1}. ${project.name}</h6>
                        <p class="mb-1 small text-muted">${project.description || 'æ— æè¿°'}</p>
                        <div class="small">
                            <span class="badge bg-primary me-1">${project.language || 'æœªçŸ¥'}</span>
                            <span class="badge bg-success me-1">â­ ${project.stars || 0}</span>
                            <span class="badge bg-info">ğŸ”€ ${project.forks || 0}</span>
                        </div>
                    </div>
                    <button 
                        class="btn btn-sm btn-outline-danger"
                        onclick="removeProject(${index})"
                    >
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ç§»é™¤é¡¹ç›®
function removeProject(index) {
    selectedProjects.splice(index, 1);
    updateSelectedProjectsDisplay();
    updateCompareButton();
}

// æ›´æ–°å¯¹æ¯”æŒ‰é’®çŠ¶æ€
function updateCompareButton() {
    const compareBtn = document.getElementById('compareBtn');
    compareBtn.disabled = selectedProjects.length < 2;
}

// å¼€å§‹å¯¹æ¯”åˆ†æ
async function startComparison() {
    if (selectedProjects.length < 2) {
        alert('è‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªé¡¹ç›®è¿›è¡Œå¯¹æ¯”');
        return;
    }
    
    const comparisonType = document.getElementById('comparisonType').value;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showComparisonLoading();
    
    try {
        const response = await fetch('/api/compare/projects', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_ids: selectedProjects.map(p => p.id),
                comparison_type: comparisonType
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showComparisonResult(data);
        } else {
            showComparisonError(data.error || 'å¯¹æ¯”åˆ†æå¤±è´¥');
        }
        
    } catch (error) {
        console.error('å¯¹æ¯”åˆ†æè¯·æ±‚å¤±è´¥:', error);
        showComparisonError('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }
}

// æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
function showComparisonResult(data) {
    hideAllComparisonStates();
    
    // æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
    document.getElementById('comparisonContent').innerHTML = formatAnswer(data.comparison);
    document.getElementById('comparisonModel').textContent = `æ¨¡å‹: ${data.model}`;
    document.getElementById('comparisonProjects').textContent = `å¯¹æ¯”é¡¹ç›®æ•°: ${data.projects_count}`;
    
    if (data.usage) {
        const usage = data.usage;
        let usageText = '';
        if (usage.total_tokens) {
            usageText = `Tokenä½¿ç”¨: ${usage.total_tokens}`;
        }
        document.getElementById('comparisonUsage').textContent = usageText;
    }
    
    document.getElementById('comparisonResult').classList.remove('d-none');
    
    // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
    document.getElementById('comparisonResult').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

// æ ¼å¼åŒ–AIå›ç­”
function formatAnswer(answer) {
    // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTML
    return answer.replace(/\n/g, '<br>');
}

// æ˜¾ç¤ºå¯¹æ¯”åŠ è½½çŠ¶æ€
function showComparisonLoading() {
    hideAllComparisonStates();
    document.getElementById('loadingState').classList.remove('d-none');
}

// æ˜¾ç¤ºå¯¹æ¯”é”™è¯¯
function showComparisonError(message) {
    hideAllComparisonStates();
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorState').classList.remove('d-none');
}

// éšè—æ‰€æœ‰å¯¹æ¯”çŠ¶æ€
function hideAllComparisonStates() {
    document.getElementById('comparisonResult').classList.add('d-none');
    document.getElementById('loadingState').classList.add('d-none');
    document.getElementById('errorState').classList.add('d-none');
}

// æ˜¾ç¤ºæœç´¢é”™è¯¯
function showSearchError(message) {
    const container = document.getElementById('searchResults');
    container.innerHTML = `<div class="alert alert-danger">${message}</div>`;
}

// å¿«é€Ÿç¤ºä¾‹å¡«å……
function fillQuickExample(type) {
    let searchTerm = '';
    if (type === 'AIæ¡†æ¶') {
        searchTerm = 'machine learning framework tensorflow pytorch';
    } else if (type === 'Webæ¡†æ¶') {
        searchTerm = 'web framework django flask fastapi';
    }
    
    document.getElementById('projectSearch').value = searchTerm;
    searchProjects();
}

// å›è½¦é”®æœç´¢
document.getElementById('projectSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchProjects();
    }
});

// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // èšç„¦åˆ°æœç´¢è¾“å…¥æ¡†
    document.getElementById('projectSearch').focus();
});
</script>
{% endblock %}

