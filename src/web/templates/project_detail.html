{% extends "base.html" %}

{% block title %}{{ project.full_name }} - helloReadme{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- 项目基本信息 -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">
                        <i class="fab fa-github me-2"></i>{{ project.full_name }}
                    </h3>
                    <div>
                        <a href="https://github.com/{{ project.full_name }}" 
                           class="btn btn-primary" target="_blank">
                            <i class="fab fa-github me-2"></i>GitHub
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if project.description %}
                <p class="lead">{{ project.description }}</p>
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>编程语言:</strong>
                        <span class="badge bg-primary ms-2">{{ project.language.value if project.language else 'Unknown' }}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>状态:</strong>
                        <span class="badge bg-{{ 'success' if project.status.value == 'active' else 'warning' }} ms-2">
                            {{ project.status.value }}
                        </span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-warning">{{ project.stars|int }}</h4>
                            <small class="text-muted">星标</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-info">{{ project.forks|int }}</h4>
                            <small class="text-muted">分支</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-secondary">{{ project.watchers|int }}</h4>
                            <small class="text-muted">关注者</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-danger">{{ project.open_issues|int }}</h4>
                            <small class="text-muted">开放问题</small>
                        </div>
                    </div>
                </div>
                
                {% if project.topics %}
                <div class="mb-3">
                    <strong>标签:</strong>
                    <div class="mt-2">
                        {% for topic in project.topics %}
                        <span class="badge bg-light text-dark me-1">{{ topic }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- README内容 -->
        {% if project.readme_content %}
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-book me-2"></i>README
                    </h5>
                    <div>
                        <span class="badge bg-info">{{ project.readme_content|length }} 字符</span>
                        {% if project.readme_encoding %}
                        <span class="badge bg-secondary ms-1">{{ project.readme_encoding }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="readme-content">
                    <pre class="readme-text">{{ project.readme_content }}</pre>
                </div>
                <div class="text-center mt-3">
                    <a href="https://github.com/{{ project.full_name }}" class="btn btn-outline-primary" target="_blank">
                        <i class="fab fa-github me-2"></i>在GitHub上查看
                    </a>
                    <button class="btn btn-outline-secondary ms-2" onclick="copyReadme()">
                        <i class="fas fa-copy me-2"></i>复制README
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-book me-2"></i>README
                </h5>
            </div>
            <div class="card-body text-center">
                <p class="text-muted">该项目没有README文件或README内容为空</p>
                <a href="https://github.com/{{ project.full_name }}" class="btn btn-outline-primary" target="_blank">
                    <i class="fab fa-github me-2"></i>在GitHub上查看
                </a>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-lg-4">
        <!-- 项目元数据 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>项目信息
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>所有者:</strong></td>
                        <td>{{ project.owner_login }}</td>
                    </tr>
                    <tr>
                        <td><strong>类型:</strong></td>
                        <td>{{ project.owner_type }}</td>
                    </tr>
                    <tr>
                        <td><strong>默认分支:</strong></td>
                        <td>{{ project.default_branch }}</td>
                    </tr>
                    <tr>
                        <td><strong>大小:</strong></td>
                        <td>{{ project.size }} KB</td>
                    </tr>
                    <tr>
                        <td><strong>创建时间:</strong></td>
                        <td>{{ project.created_at.strftime('%Y-%m-%d') }}</td>
                    </tr>
                    <tr>
                        <td><strong>更新时间:</strong></td>
                        <td>{{ project.updated_at.strftime('%Y-%m-%d') }}</td>
                    </tr>
                    <tr>
                        <td><strong>最后推送:</strong></td>
                        <td>{{ project.pushed_at.strftime('%Y-%m-%d') }}</td>
                    </tr>
                    <tr>
                        <td><strong>采集时间:</strong></td>
                        <td>{{ project.collected_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- 项目特性 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>项目特性
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-column gap-2">
                    <div class="d-flex justify-content-between">
                        <span>Wiki</span>
                        <i class="fas fa-{{ 'check text-success' if project.has_wiki else 'times text-muted' }}"></i>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Pages</span>
                        <i class="fas fa-{{ 'check text-success' if project.has_pages else 'times text-muted' }}"></i>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>分支项目</span>
                        <i class="fas fa-{{ 'check text-success' if project.is_fork else 'times text-muted' }}"></i>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>模板项目</span>
                        <i class="fas fa-{{ 'check text-success' if project.is_template else 'times text-muted' }}"></i>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>已归档</span>
                        <i class="fas fa-{{ 'check text-success' if project.is_archived else 'times text-muted' }}"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 快速操作 -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-rocket me-2"></i>快速操作
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="https://github.com/{{ project.full_name }}/issues" 
                       class="btn btn-outline-primary" target="_blank">
                        <i class="fas fa-exclamation-circle me-2"></i>查看问题
                    </a>
                    <a href="https://github.com/{{ project.full_name }}/pulls" 
                       class="btn btn-outline-success" target="_blank">
                        <i class="fas fa-code-branch me-2"></i>查看PR
                    </a>
                    <a href="https://github.com/{{ project.full_name }}/network" 
                       class="btn btn-outline-info" target="_blank">
                        <i class="fas fa-project-diagram me-2"></i>查看网络
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 返回按钮 -->
<div class="text-center mt-4">
    <a href="{{ url_for('projects') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>返回项目列表
    </a>
</div>

<!-- 自定义样式 -->
<style>
.readme-content {
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
}

.readme-text {
    margin: 0;
    padding: 1rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: #212529;
    background: transparent;
    border: none;
}

.readme-content::-webkit-scrollbar {
    width: 8px;
}

.readme-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.readme-content::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.readme-content::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.badge {
    font-size: 0.75rem;
}
</style>

<!-- JavaScript功能 -->
<script>
function copyReadme() {
    const readmeText = document.querySelector('.readme-text').textContent;
    
    // 使用现代Clipboard API
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(readmeText).then(() => {
            showCopySuccess();
        }).catch(err => {
            console.error('复制失败:', err);
            fallbackCopyTextToClipboard(readmeText);
        });
    } else {
        fallbackCopyTextToClipboard(readmeText);
    }
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showCopySuccess();
    } catch (err) {
        console.error('复制失败:', err);
        alert('复制失败，请手动复制');
    }
    
    document.body.removeChild(textArea);
}

function showCopySuccess() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-check me-2"></i>已复制';
    btn.classList.remove('btn-outline-secondary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-secondary');
    }, 2000);
}
</script>
{% endblock %}
